require 'spec_helper'
require 'ronin/code/sql/formatter'

describe Code::SQL::Formatter do
  it "should encode a keyword" do
    subject.format_keyword(:id).should == "id"
  end

  it "should encode a NULL keyword" do
    subject.format_null.should == 'null'
  end

  it "should encode a true value" do
    subject.format_boolean(true).should == 'true'
  end

  it "should encode a false value" do
    subject.format_boolean(false).should == 'false'
  end

  it "should encode an Integer" do
    subject.format_integer(10).should == '10'
  end

  it "should encode a Float" do
    subject.format_float(0.5).should == '0.5'
  end

  it "should encode a String" do
    subject.format_string('hello').should == "'hello'"
  end

  it "should encode an empty Array" do
    subject.format_list().should == "()"
  end

  it "should encode a singleton Array" do
    subject.format_list(1).should == "(1)"
  end

  it "should encode an Array" do
    subject.format_list(1,2,3).should == "(1,2,3)"
  end

  it "should encode an empty Hash" do
    subject.format_hash({}).should == "()"
  end

  it "should encode a singleton Hash" do
    subject.format_hash({:count => 5}).should == "(count=5)"
  end

  it "should encode a single Hash" do
    update = {:user => 'bob', :password => 'lol'}

    subject.format_hash(update)[1..-2].split(',').should =~ [
      "user='bob'",
      "password='lol'"
    ]
  end

  it "should encode multiple elements" do
    subject.format_elements([1, :eq, 1]).should == ['1', '=', '1']
  end

  describe "case" do
    it "should preserve case when encoding keywords by default" do
      subject.format_keyword(:Select).should == 'Select'
    end

    it "should allow encoding keywords in upper-case" do
      encoder = described_class.new(:case => :lower)

      encoder.format_keyword(:ID).should == 'id'
    end

    it "should allow encoding keywords in upper-case" do
      encoder = described_class.new(:case => :upper)

      encoder.format_keyword(:id).should == 'ID'
    end

    it "should allow encoding keywords in random-case" do
      @encoder = described_class.new(:case => :random)

      @encoder.format_keyword(:select).should_not == 'select'
    end
  end

  describe "quotes" do
    it "should single-quote strings by default" do
      subject.format_string('hello').should == "'hello'"
    end

    it "should allow double-quoting strings" do
      encoder = described_class.new(:quotes => :double)

      encoder.format_string('hello').should == '"hello"'
    end
  end

  describe "hex_escape" do
    it "should not hex-escape strings by default" do
      subject.format_string('hello').should == "'hello'"
    end

    it "should allow hex-escaping strings" do
      encoder = described_class.new(:hex_escape => true)

      encoder.format_string('hello').should == "hex(0x68656c6c6f)"
    end
  end

  describe "parenthesis" do
    it "should parenthesis all lists by default" do
      subject.format_list(1,2,3).should == "(1,2,3)"
    end

    it "should allow omitting parenthesis on non-singleton lists" do
      encoder = described_class.new(:parens => :less)

      encoder.format_list(1,2,3).should == "1,2,3"
    end

    it "should keep parenthesis on empty lists" do
      encoder = described_class.new(:parens => :less)

      encoder.format_list.should == "()"
    end
  end

  describe "space" do
    it "should space-separate elements by default" do
      subject.format_fragments([:union, :select]).should == "union select"
    end

    it "should allow comment-separated joining of elements" do
      @encoder = described_class.new(:space => false)

      @encoder.format_fragments([:union, :select]).should == "union/**/select"
    end
  end
end
