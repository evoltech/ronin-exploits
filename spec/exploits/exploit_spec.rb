require 'ronin/exploits/exploit'

require 'spec_helper'

describe Exploits::Exploit do
  it "should require a name attribute" do
    exp = Exploits::Exploit.new(:object_path => 'test.rb')
    exp.should_not be_valid

    exp.name = 'test'
    exp.should be_valid
  end

  it "should have a unique name and version" do
    first_exp = Exploits::Exploit.create(
      :object_path => 'test.rb',
      :name => 'test',
      :version => '0.0.1'
    )
    first_exp.should be_valid

    second_exp = Exploits::Exploit.new(
      :object_path => 'other.rb',
      :name => 'test',
      :version => '0.0.1'
    )
    second_exp.should_not be_valid

    third_exp = Exploits::Exploit.new(
      :object_path => 'other.rb',
      :name => 'test',
      :version => '0.0.2'
    )
    third_exp.should be_valid
  end

  it "should be able to switch between payloads" do
    exp = Exploits::Exploit.new(:name => 'test')
    exp.payload = 'payload1'

    exp.switch_payload('payload2') do
      exp.payload.should == 'payload2'
    end

    exp.payload.should == 'payload1'
  end

  it "should have 'unbuilt' and 'built' states" do
    exp = Exploits::Exploit.new(:name => 'test')

    exp.is_built?.should == false
    exp.build
    exp.is_built?.should == true
  end

  it "should return the result of the builder" do
    exp = Exploits::Exploit.new(:name => 'test') do
      def builder
        :result
      end
    end

    exp.build.should == :result
  end
end
