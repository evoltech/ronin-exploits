#
# Ronin Exploits - A Ruby library for Ronin that provides exploitation and
# payload crafting functionality.
#
# Copyright (c) 2007-2010 Hal Brodigan (postmodern.mod3 at gmail.com)
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
#

require 'ronin/vulns/vuln'
require 'ronin/vulns/url'

module Ronin
  module Vulns
    #
    # Represents vulnerabilities discovered at URLs.
    #
    class Web

      include Vuln

      # The primary-key of the web vulnerability
      property :id, Serial

      # The HTTP request method to use
      property :request_method, String, :set => [
        nil,
        'OPTIONS',
        'GET',
        'HEAD',
        'POST',
        'PUT',
        'DELETE',
        'TRACE',
        'CONNECT'
      ]

      # The HTTP header the vulnerability exists in
      property :header_name, String

      # The query-param the vulnerability exists in
      property :query_param, String

      # The original data from the query-param / header
      property :original_data, String

      # The URL the web vulnerability was found in
      belongs_to :url, :model => 'URL'

      # The proxy to use when exploiting the web vulnerability
      attr_accessor :proxy

      # Additional headers to send
      attr_accessor :headers

      # The Session Cookie to use when exploiting the web vulnerability
      attr_accessor :cookie

      #
      # Initializes the web vulnerability.
      #
      # @param [Hash] attributes
      #   Additional attributes.
      #
      # @since 0.4.0
      #
      def initialize(attributes={})
        super(attributes)

        @proxy = nil
        @headers = {}
        @cookie = nil
      end

      #
      # The targeted URI.
      #
      # @return [URI::HTTP]
      #   The targeted URI.
      #
      # @since 0.4.0
      #
      def target_uri
        @target_uri ||= self.url.to_uri
      end

      #
      # Creates an exploitation URI by injecting the data into the vulnerable
      # query-param.
      #
      # @param [Hash, String, nil] injection
      #   The data to inject.
      #
      # @return [URI::HTTP]
      #   The exploitation URI.
      #
      # @see String#inject_with
      #
      def exploit_uri(injection=nil)
        new_uri = target_uri.clone

        if (self.query_param && injection)
          original_data = new_uri.query_params[self.query_param].to_s
          injected_data = original_data.inject_with(injection)

          new_uri.query_params[self.query_param] = injected_data
        end

        return new_uri
      end

      #
      # Creates exploitation Headers by injecting the data into the vulnerable
      # HTTP Header.
      #
      # @param [Hash, String, nil] injection
      #   The data to inject.
      #
      # @return [Hash]
      #   The exploitation Headers.
      #
      # @see String#inject_with
      #
      def exploit_headers(injection=nil)
        new_headers = @headers.clone

        if (self.header_name && injection)
          original_data = new_headers[self.header_name].to_s
          injected_data = original_data.inject_with(injection)

          new_headers[self.header_name] = injected_data
        end

        return new_headers
      end

    end
  end
end
